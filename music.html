<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebéŸ³ä¹æ’­æ”¾å™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --primary-color: #ff69b4;
            --secondary-color: #ffb6c1;
            --background-color: #ffe4e1;
            --text-color: #333;
            --border-color: #000;
            --progress-bg: #f0f0f0;
            
            /* éŸ³ä¹æ’­æ”¾å™¨ä¸“ç”¨å˜é‡ */
            --background: linear-gradient(135deg, #ffe4e1, #ffb6c1, #ff69b4);
            --foreground: #333;
            --card: rgba(255, 255, 255, 0.95);
            --card-foreground: #333;
            --primary: #ff69b4;
            --primary-foreground: #ffffff;
            --primary-gradient: linear-gradient(135deg, #ff69b4, #ff1493);
            --primary-hover: rgba(255, 105, 180, 0.1);
            --primary-shadow: rgba(255, 105, 180, 0.3);
            --primary-shadow-hover: rgba(255, 105, 180, 0.4);
            --primary-shadow-light: rgba(255, 105, 180, 0.2);
            --secondary: #ffb6c1;
            --secondary-gradient: linear-gradient(135deg, #ffb6c1, #ffc0cb);
            --secondary-shadow: rgba(255, 182, 193, 0.3);
            --secondary-shadow-hover: rgba(255, 182, 193, 0.4);
            --accent: #ff69b4;
            --muted: rgba(255, 255, 255, 0.8);
            --muted-foreground: #666;
            --border: rgba(255, 105, 180, 0.2);
            --radius: 1rem;
        }

        [data-theme="blue"] {
            --primary-color: #4169e1;
            --secondary-color: #87ceeb;
            --background-color: #e6f3ff;
            --text-color: #333;
            --border-color: #000;
            --progress-bg: #f0f0f0;
            
            /* è“è‰²ä¸»é¢˜éŸ³ä¹æ’­æ”¾å™¨å˜é‡ */
            --background: linear-gradient(135deg, #e6f3ff, #87ceeb, #4169e1);
            --foreground: #333;
            --card: rgba(255, 255, 255, 0.95);
            --card-foreground: #333;
            --primary: #4169e1;
            --primary-foreground: #ffffff;
            --primary-gradient: linear-gradient(135deg, #4169e1, #6495ed);
            --primary-hover: rgba(65, 105, 225, 0.1);
            --primary-shadow: rgba(65, 105, 225, 0.3);
            --primary-shadow-hover: rgba(65, 105, 225, 0.4);
            --primary-shadow-light: rgba(65, 105, 225, 0.2);
            --secondary: #87ceeb;
            --secondary-gradient: linear-gradient(135deg, #87ceeb, #b0e0e6);
            --secondary-shadow: rgba(135, 206, 235, 0.3);
            --secondary-shadow-hover: rgba(135, 206, 235, 0.4);
            --accent: #4169e1;
            --muted: rgba(255, 255, 255, 0.8);
            --muted-foreground: #666;
            --border: rgba(65, 105, 225, 0.2);
            --radius: 1rem;
        }

        body {
            background: var(--background);
            min-height: 100vh;
        }

        .vinyl-record {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(45deg, #1f2937, #374151);
            position: relative;
            transition: transform 0.3s ease;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            /* æ·»åŠ flexå¸ƒå±€æ¥å±…ä¸­ä¸“è¾‘å°é¢ */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* æ·»åŠ ä¸“è¾‘å°é¢æ ·å¼ */
        .album-cover {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        /* æ·»åŠ å”±ç‰‡æ—‹è½¬åŠ¨ç”» */
        .vinyl-record.playing {
            animation: spin 3s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .control-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary-gradient);
            color: var(--primary-foreground);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-size: 20px;
            box-shadow: 0 4px 15px var(--primary-shadow);
        }

        .control-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px var(--primary-shadow-hover);
        }

        .control-btn.secondary {
            background: var(--secondary-gradient);
            box-shadow: 0 4px 15px var(--secondary-shadow);
        }

        .control-btn.secondary:hover {
            box-shadow: 0 6px 20px var(--secondary-shadow-hover);
        }

        .song-item {
            padding: 16px;
            background: var(--card);
            border-radius: var(--radius);
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid var(--border);
            backdrop-filter: blur(10px);
        }

        .song-item:hover {
            background: var(--primary-hover);
            transform: translateX(4px);
            box-shadow: 0 4px 15px var(--primary-shadow-light);
        }

        .song-item.active {
            background: var(--primary-gradient);
            color: var(--primary-foreground);
            box-shadow: 0 4px 15px var(--primary-shadow);
        }

        .favorite-btn {
            color: var(--muted-foreground);
            transition: all 0.2s ease;
            font-size: 28px;
        }

        .favorite-btn.active {
            color: var(--primary-color);
            text-shadow: 0 0 10px var(--primary-shadow);
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 20px;
            height: 100vh;
            padding: 10px 30px;
            background: var(--background);
            color: var(--foreground);
        }

        .player-area {
            grid-column: 1 / 5;
            grid-row: 1 / 4;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--card);
            border-radius: var(--radius);
            padding: 32px;
            position: relative;
            backdrop-filter: blur(20px);
            border: 3px solid #000;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        .playlist-area {
            grid-column: 5 / 7;
            grid-row: 1 / 3;
            background: var(--card);
            border-radius: var(--radius);
            padding: 24px;
            overflow-y: auto;
            backdrop-filter: blur(20px);
            border: 3px solid #000;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        /* éšè—æ­Œå•åŒºåŸŸæ»šåŠ¨æ¡ */
        .playlist-area::-webkit-scrollbar {
            display: none;
        }
        
        .playlist-area {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .favorites-btn {
            grid-column: 5 / 6;
            grid-row: 3 / 4;
        }

        .shuffle-btn {
            grid-column: 6 / 7;
            grid-row: 3 / 4;
        }

        .action-btn {
            border: 3px solid #000;
            border-radius: var(--radius);
            padding: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            width: 100%;
            height: 100%;
            font-size: 16px;
            backdrop-filter: blur(20px);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .action-btn.favorites {
            background: var(--primary-gradient);
            color: white;
        }

        .action-btn.shuffle {
            background: var(--secondary-gradient);
            color: white;
        }

        .action-btn:hover {
            transform: translateY(-4px);
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.2);
        }

        .playlist-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            color: var(--primary-color);
        }

        .search-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            margin-bottom: 16px;
            transition: all 0.2s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px var(--primary-hover);
        }

        /* æ·»åŠ è¿›åº¦æ¡æ ·å¼å’Œè½®å»“çº¿ */
        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
            position: relative;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .progress-fill {
            height: 100%;
            background: var(--primary-gradient);
            border-radius: 3px;
            transition: width 0.1s ease;
            box-shadow: 0 0 8px var(--primary-shadow);
        }

        .progress-thumb {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 16px;
            height: 16px;
            background: var(--primary-color);
            border-radius: 50%;
            cursor: pointer;
            transition: left 0.1s ease;
            border: 2px solid white;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .progress-thumb:hover {
            transform: translate(-50%, -50%) scale(1.2);
        }
    </style>
</head>
<body>
    <div class="grid-container">
        <div class="player-area">
            <button class="favorite-btn absolute top-6 right-6" id="favoriteBtn">
                â™¡
            </button>
            <button class="absolute top-6 left-6" onclick="parent.hideWhiteOverlay()" style="background: linear-gradient(135deg, #6b7280, #9ca3af); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; box-shadow: 0 4px 15px rgba(107, 114, 128, 0.3); transition: all 0.2s ease;" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 6px 20px rgba(107, 114, 128, 0.4)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 15px rgba(107, 114, 128, 0.3)'">
                Ã—
            </button>

            
            <div class="vinyl-record mb-8" id="vinylRecord">
                <img src="/placeholder.svg?height=120&width=120" 
                     alt="ä¸“è¾‘å°é¢" class="album-cover" id="albumCover">
            </div>
            
            <h2 class="text-2xl font-bold mb-6 text-center" id="songTitle">é€‰æ‹©ä¸€é¦–æ­Œæ›²å¼€å§‹æ’­æ”¾</h2>
            
            <div class="w-full max-w-md mb-4">
                <div class="progress-bar" id="progressBar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    <div class="progress-thumb" id="progressThumb" style="left: 0%"></div>
                </div>
            </div>
            
            <div class="flex justify-between w-full max-w-md mb-8 text-sm font-medium">
                <span id="currentTime">0:00</span>
                <span id="totalTime">0:00</span>
            </div>
            
            <div class="flex items-center gap-6">
                <button class="control-btn secondary" id="prevBtn">â®</button>
                <button class="control-btn" id="playPauseBtn">â–¶</button>
                <button class="control-btn secondary" id="nextBtn">â­</button>
            </div>
        </div>
        
        <div class="playlist-area">
            <div class="playlist-header">
                <span style="font-size: 24px;">ğŸµ</span>
                <h3 class="text-xl font-bold" id="playlistTitle">æ­Œå•</h3>
            </div>
            <p class="text-sm text-gray-600 mb-4">è¯·é€‰æ‹©æ”¶è—æˆ–éšæœºæ¨¡å¼</p>
            <input type="text" class="search-input" id="searchInput" placeholder="æœç´¢æ­Œæ›²...">
            <div id="playlist">
            </div>
        </div>
        
        <button class="action-btn favorites" id="showFavoritesBtn">
            <span style="font-size: 24px;">â¤ï¸</span>
            æˆ‘çš„æ”¶è—
        </button>
        
        <button class="action-btn shuffle" id="shufflePlayBtn">
            <span style="font-size: 24px;">ğŸ”€</span>
            éšæœºæ’­æ”¾
        </button>
    </div>

    <audio id="audioPlayer" preload="metadata"></audio>

    <script>
        class MusicPlayer {
            constructor() {
                this.apiBase = 'http://192.168.101.1:4533/rest';
                this.apiParams = {
                    u: 'tyh', // ç”¨æˆ·å
                    p: 'tyh200506240833', // å¯†ç 
                    v: '1.16.0', // APIç‰ˆæœ¬
                    c: 'WebMusicPlayer', // å®¢æˆ·ç«¯æ ‡è¯†
                    f: 'json' // è¿”å›JSONæ ¼å¼
                };
                this.currentSong = null;
                this.currentIndex = 0;
                this.isPlaying = false;
                this.playlist = [];
                this.allSongs = []; // æ·»åŠ å…¨éƒ¨æ­Œæ›²å­˜å‚¨
                this.myLikesPlaylist = null; // æˆ‘çš„å–œæ¬¢æ­Œå•
                this.myLikesSongs = []; // æˆ‘çš„å–œæ¬¢æ­Œå•ä¸­çš„æ­Œæ›²
                this.currentPlaylistType = 'all'; // 'all', 'likes', 'shuffle'
                
                this.initElements();
                this.setupEventListeners();
                this.loadPlaylist();
                this.loadMyLikesPlaylist(); // åŠ è½½æˆ‘çš„å–œæ¬¢æ­Œå•
            }
            
            initElements() {
                this.audioPlayer = document.getElementById('audioPlayer');
                this.vinylRecord = document.getElementById('vinylRecord');
                this.albumCover = document.getElementById('albumCover');
                this.songTitle = document.getElementById('songTitle');
                this.playPauseBtn = document.getElementById('playPauseBtn');
                this.prevBtn = document.getElementById('prevBtn');
                this.nextBtn = document.getElementById('nextBtn');
                this.favoriteBtn = document.getElementById('favoriteBtn');
                this.progressBar = document.getElementById('progressBar');
                this.progressFill = document.getElementById('progressFill');
                this.progressThumb = document.getElementById('progressThumb');
                this.currentTime = document.getElementById('currentTime');
                this.totalTime = document.getElementById('totalTime');
                this.playlistContainer = document.getElementById('playlist');
                this.showFavoritesBtn = document.getElementById('showFavoritesBtn');
                this.shufflePlayBtn = document.getElementById('shufflePlayBtn');
                this.searchInput = document.getElementById('searchInput');
                this.playlistTitle = document.getElementById('playlistTitle');
            }
            
            setupEventListeners() {
                this.playPauseBtn.addEventListener('click', () => this.togglePlay());
                this.prevBtn.addEventListener('click', () => this.previousSong());
                this.nextBtn.addEventListener('click', () => this.nextSong());
                this.favoriteBtn.addEventListener('click', () => this.toggleFavorite());
                this.showFavoritesBtn.addEventListener('click', () => this.showFavorites());
                this.shufflePlayBtn.addEventListener('click', () => this.shufflePlay());
                this.searchInput.addEventListener('input', (e) => this.searchSongs(e.target.value));
                
                this.progressBar.addEventListener('click', (e) => this.seekTo(e));
                this.progressThumb.addEventListener('mousedown', (e) => this.startDrag(e));
                
                this.audioPlayer.addEventListener('timeupdate', () => this.updateProgress());
                this.audioPlayer.addEventListener('ended', () => {
                    this.nextSong();
                    this.notifyParentMusicStatus('musicEnded');
                });
                this.audioPlayer.addEventListener('loadedmetadata', () => this.updateDuration());
                
                // æ·»åŠ æ’­æ”¾å’Œæš‚åœäº‹ä»¶ç›‘å¬
                this.audioPlayer.addEventListener('play', () => {
                    this.isPlaying = true;
                    this.updatePlayButton();
                    this.notifyParentMusicStatus('musicPlay');
                });
                
                this.audioPlayer.addEventListener('pause', () => {
                    this.isPlaying = false;
                    this.updatePlayButton();
                    this.notifyParentMusicStatus('musicPause');
                });
                
                // æ·»åŠ éŸ³é¢‘åŠ è½½å®Œæˆäº‹ä»¶ç›‘å¬
                this.audioPlayer.addEventListener('canplay', () => {
                    // éŸ³é¢‘å¯ä»¥æ’­æ”¾æ—¶ï¼Œæ£€æŸ¥å¹¶åŒæ­¥çŠ¶æ€
                    this.checkAndSyncAudioState();
                });
                
                // æ·»åŠ éŸ³é¢‘æ•°æ®åŠ è½½äº‹ä»¶ç›‘å¬
                this.audioPlayer.addEventListener('loadeddata', () => {
                    // éŸ³é¢‘æ•°æ®åŠ è½½å®Œæˆæ—¶ï¼Œæ£€æŸ¥å¹¶åŒæ­¥çŠ¶æ€
                    this.checkAndSyncAudioState();
                });
            }

            async loadMyLikesPlaylist() {
                try {
                    console.log('[v0] å¼€å§‹åŠ è½½æ­Œå•åˆ—è¡¨');
                    const url = this.buildApiUrl('getPlaylists');
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (data['subsonic-response'] && data['subsonic-response'].status === 'ok') {
                        const playlists = data['subsonic-response'].playlists?.playlist || [];
                        console.log('[v0] æ‰¾åˆ°æ­Œå•:', playlists.map(p => p.name));
                        
                        this.myLikesPlaylist = playlists.find(playlist => 
                            playlist.name === 'æˆ‘çš„å–œæ¬¢' || 
                            playlist.name === 'My Likes' || 
                            playlist.name === 'Favorites' ||
                            playlist.name.toLowerCase().includes('like') ||
                            playlist.name.toLowerCase().includes('favorite')
                        );
                        
                        if (this.myLikesPlaylist) {
                            console.log('[v0] æ‰¾åˆ°æˆ‘çš„å–œæ¬¢æ­Œå•:', this.myLikesPlaylist.name);
                            await this.loadMyLikesSongs();
                        } else {
                            console.log('[v0] æœªæ‰¾åˆ°æˆ‘çš„å–œæ¬¢æ­Œå•ï¼Œå°†åˆ›å»ºä¸€ä¸ª');
                            await this.createMyLikesPlaylist();
                        }
                    }
                } catch (error) {
                    console.error('[v0] åŠ è½½æ­Œå•å¤±è´¥:', error);
                    this.myLikesSongs = JSON.parse(localStorage.getItem('myLikes') || '[]');
                }
            }

            async createMyLikesPlaylist() {
                try {
                    const url = this.buildApiUrl('createPlaylist', { name: 'æˆ‘çš„å–œæ¬¢' });
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (data['subsonic-response'] && data['subsonic-response'].status === 'ok') {
                        console.log('[v0] æˆåŠŸåˆ›å»ºæˆ‘çš„å–œæ¬¢æ­Œå•');
                        await this.loadMyLikesPlaylist();
                    }
                } catch (error) {
                    console.error('[v0] åˆ›å»ºæ­Œå•å¤±è´¥:', error);
                }
            }

            async loadMyLikesSongs() {
                if (!this.myLikesPlaylist) return;
                
                try {
                    const url = this.buildApiUrl('getPlaylist', { id: this.myLikesPlaylist.id });
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (data['subsonic-response'] && data['subsonic-response'].status === 'ok') {
                        const playlist = data['subsonic-response'].playlist;
                        const songs = playlist.entry || [];
                        
                        this.myLikesSongs = songs.map(song => ({
                            id: song.id,
                            title: song.title,
                            artist: song.artist,
                            album: song.album,
                            duration: song.duration,
                            url: this.buildApiUrl('stream', { id: song.id }),
                            cover: song.coverArt ? this.buildApiUrl('getCoverArt', { id: song.coverArt, size: 120 }) : '/placeholder.svg?height=120&width=120'
                        }));
                        
                        console.log('[v0] å·²åŠ è½½æˆ‘çš„å–œæ¬¢æ­Œæ›²:', this.myLikesSongs.length);
                        this.renderPlaylist();
                    }
                } catch (error) {
                    console.error('[v0] åŠ è½½æˆ‘çš„å–œæ¬¢æ­Œæ›²å¤±è´¥:', error);
                }
            }
            
            async loadPlaylist() {
                try {
                    console.log('[v0] å¼€å§‹åŠ è½½Subsonicæ­Œæ›²åˆ—è¡¨');
                    const pingUrl = this.buildApiUrl('ping');
                    console.log('[v0] æµ‹è¯•è¿æ¥:', pingUrl);
                    
                    const pingResponse = await fetch(pingUrl);
                    const pingData = await pingResponse.json();
                    
                    if (pingData['subsonic-response']?.status !== 'ok') {
                        throw new Error('æœåŠ¡å™¨è¿æ¥å¤±è´¥: ' + (pingData['subsonic-response']?.error?.message || 'æœªçŸ¥é”™è¯¯'));
                    }
                    
                    console.log('[v0] æœåŠ¡å™¨è¿æ¥æˆåŠŸï¼Œå¼€å§‹è·å–æ­Œæ›²');
                    const url = this.buildApiUrl('getRandomSongs', { size: 50 });
                    
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    console.log('[v0] APIå“åº”:', data);
                    
                    if (data['subsonic-response'] && data['subsonic-response'].status === 'ok') {
                        const songs = data['subsonic-response'].randomSongs?.song || [];
                        this.allSongs = songs.map(song => ({
                            id: song.id,
                            title: song.title,
                            artist: song.artist,
                            album: song.album,
                            duration: song.duration,
                            url: this.buildApiUrl('stream', { id: song.id }),
                            cover: song.coverArt ? this.buildApiUrl('getCoverArt', { id: song.coverArt, size: 120 }) : '/placeholder.svg?height=120&width=120'
                        }));
                        this.playlist = [...this.allSongs]; // å¤åˆ¶åˆ°å½“å‰æ’­æ”¾åˆ—è¡¨
                        console.log('[v0] æˆåŠŸåŠ è½½æ­Œæ›²:', this.playlist.length);
                        this.renderPlaylist();
                    } else {
                        throw new Error('APIè¿”å›é”™è¯¯çŠ¶æ€: ' + (data['subsonic-response']?.error?.message || 'æœªçŸ¥é”™è¯¯'));
                    }
                } catch (error) {
                    console.error('[v0] åŠ è½½æ’­æ”¾åˆ—è¡¨å¤±è´¥:', error);
                    this.showError(`è¿æ¥å¤±è´¥: ${error.message}`);
                    this.allSongs = [
                        { 
                            id: '1', 
                            title: 'ç¤ºä¾‹æ­Œæ›² 1', 
                            artist: 'è‰ºæœ¯å®¶ 1', 
                            album: 'ä¸“è¾‘ 1',
                            url: '/placeholder.mp3', 
                            cover: '/placeholder.svg?height=120&width=120' 
                        },
                        { 
                            id: '2', 
                            title: 'ç¤ºä¾‹æ­Œæ›² 2', 
                            artist: 'è‰ºæœ¯å®¶ 2', 
                            album: 'ä¸“è¾‘ 2',
                            url: '/placeholder.mp3', 
                            cover: '/placeholder.svg?height=120&width=120' 
                        },
                        { 
                            id: '3', 
                            title: 'ç¤ºä¾‹æ­Œæ›² 3', 
                            artist: 'è‰ºæœ¯å®¶ 3', 
                            album: 'ä¸“è¾‘ 3',
                            url: '/placeholder.mp3', 
                            cover: '/placeholder.svg?height=120&width=120' 
                        }
                    ];
                    this.playlist = [...this.allSongs];
                    this.renderPlaylist();
                }
            }
            
            showError(message) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded shadow-lg z-50';
                errorDiv.textContent = message;
                document.body.appendChild(errorDiv);
                
                setTimeout(() => {
                    document.body.removeChild(errorDiv);
                }, 5000);
            }
            
            renderPlaylist() {
                this.playlistContainer.innerHTML = '';
                const currentPlaylist = this.getCurrentPlaylist();
                
                this.playlistTitle.textContent = this.getPlaylistTitle();
                
                currentPlaylist.forEach((song, index) => {
                    const songItem = document.createElement('div');
                    songItem.className = `song-item ${this.currentSong && this.currentSong.id === song.id ? 'active' : ''}`;
                    songItem.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="flex-1 min-w-0">
                                <div class="font-medium truncate">${song.title}</div>
                                <div class="text-sm opacity-70 truncate">${song.artist}${song.album ? ' - ' + song.album : ''}</div>
                            </div>
                            <button class="text-lg ml-2 ${this.isInMyLikes(song.id) ? 'text-red-500' : 'text-gray-400'}" 
                                    onclick="player.toggleSongInMyLikes('${song.id}')">â™¡</button>
                        </div>
                    `;
                    songItem.addEventListener('click', () => this.playSong(song, index));
                    this.playlistContainer.appendChild(songItem);
                });
            }
            
            getPlaylistTitle() {
                switch (this.currentPlaylistType) {
                    case 'likes':
                        return `æˆ‘çš„å–œæ¬¢ (${this.getCurrentPlaylist().length} é¦–)`;
                    case 'shuffle':
                        return `éšæœºæ’­æ”¾ (${this.getCurrentPlaylist().length} é¦–)`;
                    default:
                        return `å…¨éƒ¨æ­Œæ›² (${this.getCurrentPlaylist().length} é¦–)`;
                }
            }

            playSong(song, index) {
                console.log('[v0] å¼€å§‹æ’­æ”¾æ­Œæ›²:', song.title);
                this.currentSong = song;
                this.currentIndex = index;
                this.audioPlayer.src = song.url;
                this.songTitle.textContent = `${song.title} - ${song.artist}`;
                this.albumCover.src = song.cover;
                this.updateFavoriteButton();
                this.renderPlaylist();
                
                this.audioPlayer.play().then(() => {
                    console.log('[v0] æ­Œæ›²æ’­æ”¾æˆåŠŸ');
                    this.isPlaying = true;
                    this.updatePlayButton();
                }).catch(error => {
                    console.error('[v0] æ’­æ”¾å¤±è´¥:', error);
                    this.showError('æ’­æ”¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                });
            }
            
            togglePlay() {
                if (!this.currentSong) {
                    if (this.playlist.length > 0) {
                        this.playSong(this.playlist[0], 0);
                    }
                    return;
                }
                
                if (this.isPlaying) {
                    this.audioPlayer.pause();
                    this.isPlaying = false;
                } else {
                    this.audioPlayer.play().then(() => {
                        this.isPlaying = true;
                    });
                }
                this.updatePlayButton();
            }
            
            previousSong() {
                const currentPlaylist = this.getCurrentPlaylist();
                if (currentPlaylist.length === 0) return;
                
                this.currentIndex = (this.currentIndex - 1 + currentPlaylist.length) % currentPlaylist.length;
                this.playSong(currentPlaylist[this.currentIndex], this.currentIndex);
            }
            
            nextSong() {
                const currentPlaylist = this.getCurrentPlaylist();
                if (currentPlaylist.length === 0) return;
                
                this.currentIndex = (this.currentIndex + 1) % currentPlaylist.length;
                this.playSong(currentPlaylist[this.currentIndex], this.currentIndex);
            }
            
            async toggleFavorite() {
                if (!this.currentSong) return;
                
                await this.toggleSongInMyLikes(this.currentSong.id);
            }

            isInMyLikes(songId) {
                return this.myLikesSongs.some(song => song.id === songId);
            }

            async toggleSongInMyLikes(songId) {
                if (!this.myLikesPlaylist) {
                    console.log('[v0] æˆ‘çš„å–œæ¬¢æ­Œå•ä¸å­˜åœ¨ï¼Œå°è¯•åˆ›å»º');
                    await this.createMyLikesPlaylist();
                    if (!this.myLikesPlaylist) return;
                }

                const isInLikes = this.isInMyLikes(songId);
                
                try {
                    if (isInLikes) {
                        const songIndex = this.myLikesSongs.findIndex(song => song.id === songId);
                        if (songIndex !== -1) {
                            const url = this.buildApiUrl('updatePlaylist', { 
                                playlistId: this.myLikesPlaylist.id,
                                songIndexToRemove: songIndex
                            });
                            const response = await fetch(url);
                            const data = await response.json();
                            
                            if (data['subsonic-response'] && data['subsonic-response'].status === 'ok') {
                                this.myLikesSongs.splice(songIndex, 1);
                                console.log('[v0] å·²ä»æˆ‘çš„å–œæ¬¢ä¸­ç§»é™¤æ­Œæ›²');
                            }
                        }
                    } else {
                        const url = this.buildApiUrl('updatePlaylist', { 
                            playlistId: this.myLikesPlaylist.id,
                            songIdToAdd: songId
                        });
                        const response = await fetch(url);
                        const data = await response.json();
                        
                        if (data['subsonic-response'] && data['subsonic-response'].status === 'ok') {
                            await this.loadMyLikesSongs();
                            console.log('[v0] å·²æ·»åŠ æ­Œæ›²åˆ°æˆ‘çš„å–œæ¬¢');
                        }
                    }
                    
                    this.updateFavoriteButton();
                    this.renderPlaylist();
                } catch (error) {
                    console.error('[v0] æ›´æ–°æˆ‘çš„å–œæ¬¢å¤±è´¥:', error);
                    let localLikes = JSON.parse(localStorage.getItem('myLikes') || '[]');
                    const songIndex = localLikes.findIndex(id => id === songId);
                    
                    if (songIndex > -1) {
                        localLikes.splice(songIndex, 1);
                    } else {
                        localLikes.push(songId);
                    }
                    
                    localStorage.setItem('myLikes', JSON.stringify(localLikes));
                    this.updateFavoriteButton();
                    this.renderPlaylist();
                }
            }
            
            async searchSongs(query) {
                if (!query.trim()) {
                    this.currentPlaylistType = 'all';
                    this.renderPlaylist();
                    return;
                }
                
                try {
                    const url = this.buildApiUrl('search3', { 
                        query: query,
                        songCount: 20,
                        artistCount: 0,
                        albumCount: 0
                    });
                    
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (data['subsonic-response'] && data['subsonic-response'].status === 'ok') {
                        const songs = data['subsonic-response'].searchResult3?.song || [];
                        this.playlist = songs.map(song => ({
                            id: song.id,
                            title: song.title,
                            artist: song.artist,
                            album: song.album,
                            duration: song.duration,
                            url: this.buildApiUrl('stream', { id: song.id }),
                            cover: song.coverArt ? this.buildApiUrl('getCoverArt', { id: song.coverArt, size: 120 }) : '/placeholder.svg?height=120&width=120'
                        }));
                        this.currentPlaylistType = 'search';
                        this.renderPlaylist();
                    }
                } catch (error) {
                    console.error('[v0] æœç´¢å¤±è´¥:', error);
                    const filteredSongs = this.allSongs.filter(song => 
                        song.title.toLowerCase().includes(query.toLowerCase()) ||
                        song.artist.toLowerCase().includes(query.toLowerCase()) ||
                        song.album.toLowerCase().includes(query.toLowerCase())
                    );
                    this.playlist = filteredSongs;
                    this.currentPlaylistType = 'search';
                    this.renderPlaylist();
                }
            }
            
            async shufflePlay() {
                try {
                    console.log('[v0] å¼€å§‹éšæœºæ’­æ”¾');
                    const url = this.buildApiUrl('getRandomSongs', { size: 20 });
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (data['subsonic-response'] && data['subsonic-response'].status === 'ok') {
                        const songs = data['subsonic-response'].randomSongs?.song || [];
                        const shuffledPlaylist = songs.map(song => ({
                            id: song.id,
                            title: song.title,
                            artist: song.artist,
                            album: song.album,
                            duration: song.duration,
                            url: this.buildApiUrl('stream', { id: song.id }),
                            cover: song.coverArt ? this.buildApiUrl('getCoverArt', { id: song.coverArt, size: 120 }) : '/placeholder.svg?height=120&width=120'
                        }));
                        
                        this.playlist = shuffledPlaylist;
                        this.currentPlaylistType = 'shuffle';
                        
                        if (shuffledPlaylist.length > 0) {
                            this.playSong(shuffledPlaylist[0], 0);
                        }
                        this.renderPlaylist();
                    }
                } catch (error) {
                    console.error('[v0] éšæœºæ’­æ”¾å¤±è´¥:', error);
                    this.currentPlaylistType = 'shuffle';
                    const shuffledPlaylist = this.getCurrentPlaylist();
                    if (shuffledPlaylist.length > 0) {
                        this.playSong(shuffledPlaylist[0], 0);
                    }
                    this.renderPlaylist();
                }
            }
            
            updatePlayButton() {
                this.playPauseBtn.textContent = this.isPlaying ? 'â¸' : 'â–¶';
                /* æ·»åŠ å”±ç‰‡æ—‹è½¬æ§åˆ¶ */
                if (this.isPlaying) {
                    this.vinylRecord.classList.add('playing');
                } else {
                    this.vinylRecord.classList.remove('playing');
                }
            }
            
            updateFavoriteButton() {
                if (this.currentSong) {
                    const isInLikes = this.isInMyLikes(this.currentSong.id);
                    this.favoriteBtn.textContent = isInLikes ? 'â™¥' : 'â™¡';
                    this.favoriteBtn.className = `favorite-btn absolute top-6 right-6 ${isInLikes ? 'active' : ''}`;
                }
            }
            
            updateProgress() {
                if (this.audioPlayer.duration) {
                    const progress = (this.audioPlayer.currentTime / this.audioPlayer.duration) * 100;
                    this.progressFill.style.width = `${progress}%`;
                    this.progressThumb.style.left = `${progress}%`;
                    this.currentTime.textContent = this.formatTime(this.audioPlayer.currentTime);
                }
            }
            
            updateDuration() {
                this.totalTime.textContent = this.formatTime(this.audioPlayer.duration);
            }
            
            seekTo(e) {
                if (!this.audioPlayer.duration) return;
                
                const rect = this.progressBar.getBoundingClientRect();
                const percent = (e.clientX - rect.left) / rect.width;
                this.audioPlayer.currentTime = percent * this.audioPlayer.duration;
            }
            
            startDrag(e) {
                e.preventDefault();
                const onMouseMove = (e) => {
                    const rect = this.progressBar.getBoundingClientRect();
                    const percent = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
                    if (this.audioPlayer.duration) {
                        this.audioPlayer.currentTime = percent * this.audioPlayer.duration;
                    }
                };
                
                const onMouseUp = () => {
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                };
                
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            }
            
            formatTime(seconds) {
                if (isNaN(seconds)) return '0:00';
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }
            
            /**
             * é€šçŸ¥çˆ¶é¡µé¢éŸ³ä¹æ’­æ”¾çŠ¶æ€
             */
            notifyParentMusicStatus(type) {
                // å¦‚æœåœ¨iframeä¸­ï¼Œå‘çˆ¶é¡µé¢å‘é€æ¶ˆæ¯
                if (window.parent && window.parent !== window) {
                    window.parent.postMessage({ type: type }, window.location.origin);
                }
                // å¦‚æœæ˜¯ç‹¬ç«‹é¡µé¢ï¼Œå‘ä¸»é¡µé¢å‘é€æ¶ˆæ¯
                if (window.opener) {
                    window.opener.postMessage({ type: type }, window.location.origin);
                }
            }
            
            getCurrentPlaylist() {
                switch (this.currentPlaylistType) {
                    case 'likes':
                        return this.myLikesSongs;
                    case 'shuffle':
                        return this.playlist; // éšæœºæ’­æ”¾æ—¶ä½¿ç”¨å½“å‰çš„éšæœºåˆ—è¡¨
                    default:
                        return this.allSongs;
                }
            }
            
            /**
             * æ£€æŸ¥éŸ³é¢‘çŠ¶æ€å¹¶åŒæ­¥UI
             * ç”¨äºé¡µé¢é‡æ–°åŠ è½½æ—¶æ¢å¤æ­£ç¡®çš„æ’­æ”¾çŠ¶æ€æ˜¾ç¤º
             */
            checkAndSyncAudioState() {
                // é˜²æ­¢é‡å¤è°ƒç”¨
                if (this._syncingState) {
                    return;
                }
                this._syncingState = true;
                
                // å»¶è¿Ÿæ‰§è¡Œä»¥ç¡®ä¿éŸ³é¢‘å…ƒç´ å®Œå…¨åŠ è½½
                setTimeout(() => {
                    try {
                        if (!this.audioPlayer) {
                            console.log('[v0] éŸ³é¢‘å…ƒç´ æœªæ‰¾åˆ°ï¼Œè·³è¿‡çŠ¶æ€åŒæ­¥');
                            return;
                        }
                        
                        // æ£€æŸ¥éŸ³é¢‘æ˜¯å¦æ­£åœ¨æ’­æ”¾
                        const isAudioPlaying = !this.audioPlayer.paused && !this.audioPlayer.ended && this.audioPlayer.currentTime >= 0 && this.audioPlayer.src;
                        
                        console.log('[v0] éŸ³é¢‘çŠ¶æ€æ£€æŸ¥:', {
                            paused: this.audioPlayer.paused,
                            ended: this.audioPlayer.ended,
                            currentTime: this.audioPlayer.currentTime,
                            src: this.audioPlayer.src,
                            readyState: this.audioPlayer.readyState,
                            isPlaying: isAudioPlaying,
                            currentIsPlaying: this.isPlaying
                        });
                        
                        // åªæœ‰å½“çŠ¶æ€çœŸçš„ä¸åŒæ­¥æ—¶æ‰æ›´æ–°
                        if (isAudioPlaying !== this.isPlaying) {
                            this.isPlaying = isAudioPlaying;
                            this.updatePlayButton();
                            
                            if (isAudioPlaying) {
                                console.log('[v0] æ¢å¤æ’­æ”¾çŠ¶æ€ï¼šæ’­æ”¾ä¸­');
                            } else {
                                console.log('[v0] æ¢å¤æ’­æ”¾çŠ¶æ€ï¼šå·²æš‚åœ');
                            }
                        }
                    } finally {
                        this._syncingState = false;
                    }
                }, 100); // å»¶è¿Ÿ100msç¡®ä¿DOMå®Œå…¨åŠ è½½
            }

            showFavorites() {
                this.currentPlaylistType = 'likes';
                this.renderPlaylist();
            }

            buildApiUrl(endpoint, additionalParams = {}) {
                const params = { ...this.apiParams, ...additionalParams };
                const queryString = Object.keys(params)
                    .map(key => `${encodeURIComponent(key)}=${encodeURIComponent(params[key])}`)
                    .join('&');
                return `${this.apiBase}/${endpoint}?${queryString}`;
            }
        }
        
        const player = new MusicPlayer();
        
        // é¡µé¢åŠ è½½æ—¶ä»localStorageè¯»å–ä¸»é¢˜è®¾ç½®ï¼ˆä¸index.htmlåŒæ­¥ï¼‰
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme && savedTheme === 'blue') {
                document.documentElement.setAttribute('data-theme', 'blue');
            }
            
            // æ£€æŸ¥éŸ³é¢‘çŠ¶æ€å¹¶åŒæ­¥UI
            player.checkAndSyncAudioState();
        });
        
        // ç›‘å¬ä¸»é¢˜å˜åŒ–äº‹ä»¶ï¼ˆå½“index.htmlåˆ‡æ¢ä¸»é¢˜æ—¶åŒæ­¥æ›´æ–°ï¼‰
        window.addEventListener('storage', function(e) {
            if (e.key === 'theme') {
                const newTheme = e.newValue;
                if (newTheme === 'blue') {
                    document.documentElement.setAttribute('data-theme', 'blue');
                } else {
                    document.documentElement.removeAttribute('data-theme');
                }
            }
        });
    </script>
</body>
</html>
